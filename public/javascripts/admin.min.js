$(function(){function n(){$("select.movie").each(function(){for(var i=0;i<titles.length;i++)$(this).append("<option attr-id="+ids[i]+" value="+(i+1)+">"+ids[i]+". "+titles[i]+"</option>")})}function t(i){e(i+"\n")}function e(i){$("#result-update:hidden").show(),$("#result-update").append(i),$(document).scrollTop($(document).height())}function r(n){if(arrayOfLines=n.match(/[^\r\n]+/g),result="",arrayOfLines)for(i=0;i<arrayOfLines.length;i++)result+="	"+arrayOfLines[i]+"\n";return result}function a(){c=!0}function o(){c=!1}function s(){c&&e(".")}function l(){$("#submit-update").addClass("disabled")}function u(){$("#submit-update").removeClass("disabled")}function d(i){if("undefined"==typeof i)return"";if(i.length<=11)return i;var n=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,t=i.match(n);return t&&11==t[2].length?t[2]:""}function f(i,n,a,o,s,l){var u=$.Deferred();trailers=d(s),""!=d(l)&&(trailers+="*"+d(l)),e(":: updating ["+i+"] '"+n+"' ");var f=(new Date).getTime();return url="/movies/update",$.post(url,{id:i.toString(),kinopoisk_id:a.toString(),imdb_id:o.toString(),trailers:trailers.toString()}).done(function(i){(new Date).getTime()-f;t("\n"+r(i))}).fail(function(){t("\n:: error")}).always(function(){u.resolve()}),u.promise()}var c=!1;$("select.movie").change(function(){parent=$(this).closest(".movie-edit"),$(this).val()>0?(i=$(this).val()-1,parent.find(".kinopoisk").val(kinopoiskIds[i]),parent.find(".imdb").val(imdbIds[i]),parent.find(".trailer-original").val(trailers_original[i]),parent.find(".trailer-russian").val(trailers_russian[i])):(parent.find(".kinopoisk").val(""),parent.find(".imdb").val(""),parent.find(".trailer-original").val(""),parent.find(".trailer-russian").val(""))}).change(),$(".trailer-russian, .trailer-original").blur(function(){$(this).val(d($(this).val()))}),$("#submit-update").click(function(){var n=$.when(!0),t=[];for(a(),l(),$(".movie-edit").each(function(){var i=$(this).find(".movie").val()-1;if(i>=0){var n=ids[i],e=titles[i],r=$(this).find(".kinopoisk").val(),a=$(this).find(".imdb").val(),o=$(this).find(".trailer-original").val(),s=$(this).find(".trailer-russian").val();"undefined"!=typeof n&&t.push(function(){return f(n,e,r,a,o,s)})}}),i=0;i<t.length;i++)n=n.then(t[i]);n=n.done(o,u)}),$(document).ready(function(){admin&&n(),window.setInterval(function(){s()},1e3)})});