$(function(){function t(){$("select.movie").each(function(){for(var t=0;t<titles.length;t++)$(this).append("<option attr-id="+ids[t]+" value="+(t+1)+">"+"["+ids[t]+"] "+titles[t]+"</option>")})}function n(t){e(t+"\n")}function e(t){$("#result-update:hidden").show(),$("#result-update").append(t),$(document).scrollTop($(document).height())}function r(t){if(arrayOfLines=t.match(/[^\r\n]+/g),result="",arrayOfLines)for(i=0;i<arrayOfLines.length;i++)result+="	"+arrayOfLines[i]+"\n";return result}function a(){f=!0}function o(){f=!1}function s(){f&&e(".")}function l(){$("#submit-update").attr("disabled",!0)}function u(){$("#submit-update").removeAttr("disabled")}function c(t){if("undefined"==typeof t)return"";if(t.length<=11)return t;var i=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,n=t.match(i);return n&&11==n[2].length?n[2]:""}function d(t,i,a,o,s,l){var u=$.Deferred();trailers=c(s),""!=c(l)&&(trailers+="*"+c(l)),e(":: updating ["+t+"] '"+i+"' ");var d=(new Date).getTime();return url="/movies/update",$.post(url,{id:t.toString(),kinopoisk_id:a.toString(),imdb_id:o.toString(),trailers:trailers.toString()}).done(function(t){(new Date).getTime()-d,n("\n"+r(t))}).fail(function(){n("\n:: error")}).always(function(){u.resolve()}),u.promise()}var f=!1;$("select.movie").change(function(){parent=$(this).closest(".movie-edit"),$(this).val()>0?(i=$(this).val()-1,parent.find(".kinopoisk").val(kinopoiskIds[i]),parent.find(".imdb").val(imdbIds[i]),parent.find(".trailer-original").val(trailers_original[i]),parent.find(".trailer-russian").val(trailers_russian[i])):(parent.find(".kinopoisk").val(""),parent.find(".imdb").val(""),parent.find(".trailer-original").val(""),parent.find(".trailer-russian").val(""))}).change(),$(".trailer-russian, .trailer-original").blur(function(){$(this).val(c($(this).val()))}),$("#submit-update").click(function(){var t=$.when(!0),n=[];for(a(),l(),$(".movie-edit").each(function(){var t=$(this).find(".movie").val()-1;if(t>=0){var i=ids[t],e=titles[t],r=$(this).find(".kinopoisk").val(),a=$(this).find(".imdb").val(),o=$(this).find(".trailer-original").val(),s=$(this).find(".trailer-russian").val();"undefined"!=typeof i&&n.push(function(){return d(i,e,r,a,o,s)})}}),i=0;i<n.length;i++)t=t.then(n[i]);t=t.done(o,u)}),$(document).ready(function(){admin&&t(),window.setInterval(function(){s()},1e3)})});